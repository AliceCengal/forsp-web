(function(){"use strict";const M="<",b=">",Q="'",F=":",G="@",c={NIL:0,ATOM:1,NUM:2,PAIR:3,CLOS:4,PRIM:5,STRING:6};function K(){return{tag:0}}function L(n){return{tag:1,atom:n}}function d(n){return{tag:2,num:n}}function j(n){return{tag:6,str:n}}function w(n,r){return{tag:3,pair:{car:n,cdr:r}}}function H(n,r){return{tag:4,clos:{body:n,env:{head:r}}}}function V(n){return{tag:5,prim:{func:n}}}function s(n,r){const t=n.internedAtoms.find(i=>i.atom===r);if(t)return t;const e=L(r);return n.internedAtoms.push(e),e}function P(n){if(n.tag!==c.PAIR)throw new Error("Cannot car a not-Pair");return n.pair.car}function E(n){if(n.tag!==c.PAIR)throw new Error("Cannot cdr a not-Pair");return n.pair.cdr}function q(n,r){return n==r||n.tag===c.NUM&&r.tag===c.NUM&&n.num===r.num}function f(n){return n.tag===c.NUM?n.num:NaN}function l(n){return n.input.length===n.inputPos?"":n.input.charAt(n.inputPos)}function p(n){n.input.length>n.inputPos&&n.inputPos++}function A(n){return n.trim().length===0}const W=["(",")",";"];function x(n){return A(n)||W.includes(n)}function S(n){const r=l(n);if(r!==""){if(A(r))return p(n),S(n);if(r===";"){for(p(n);;){const t=l(n);if(t==="")return;if(p(n),t===`
`)break}S(n)}}}function h(n){if(n.readStack.length)return n.readStack.pop();S(n);const r=l(n);if(r==="")return null;if(r===Q||r===F)return p(n),n.QUOTE;if(r===M)if(p(n),l(n)===M)n.inputPos--;else return n.readStack.push(n.PUSH,k(n),n.QUOTE),h(n);if(r===b)if(p(n),l(n)===b)n.inputPos--;else return n.readStack.push(n.POP,k(n),n.QUOTE),h(n);return r===G?(p(n),l(n)==="!"&&(p(n),n.readStack.push(s(n,"force"))),n.readStack.push(s(n,"dict-get"),k(n),n.QUOTE),h(n)):r==='"'?(p(n),D(n)):r==="("?(p(n),y(n)):k(n)}function k(n){const r=n.inputPos;for(;!x(l(n));)p(n);const t=n.input.slice(r,n.inputPos),e=Number(t);return Number.isNaN(e)?s(n,t):d(e)}function y(n){if(!n.readStack.length&&(S(n),l(n)===")"))return p(n),n.NIL;const r=h(n),t=y(n);return w(r,t)}function D(n){const r=n.inputPos;let t=l(n),e=!1;for(;e||t!=='"';)e=t=="\\",p(n),t=l(n);let i=n.input.slice(r,n.inputPos);return i=JSON.parse(`"${i}"`),p(n),j(i)}function J(n,r){n.io.std.printLine(T(r))}function T(n){switch(n.tag){case c.NIL:return"()";case c.ATOM:return n.atom;case c.NUM:return n.num.toString();case c.STRING:return n.str;case c.PAIR:return`(${T(n.pair.car)}${C(n.pair.cdr)}`;case c.CLOS:return`CLOSURE<${T(n.clos.body)}>`;case c.PRIM:return`PRIM<${n.prim.func.name||n.prim.func.toString()}>`;default:return"UNKNOWN_VALUE"}}function C(n){switch(n.tag){case c.NIL:return")";case c.PAIR:return` ${T(n.pair.car)}${C(n.pair.cdr)}`;default:return` . ${T(n)})`}}function O(n,r){if(r.tag!==c.ATOM)throw new Error("Expected 'key' to be an atom in envFind");let t=n.head;for(;t.tag!=c.NIL;){const e=P(t);if(r==P(e))return E(e);t=E(t)}throw new Error(`Failed to find '${r.atom||JSON.stringify(r)}' in environment`)}function _(n,r,t){n.head=w(w(r,t),n.head)}function R(n,r,t,e){return _(r,s(n,t),V(e))}function a(n,r){n.stack=w(r,n.stack)}function o(n){if(n.stack===n.NIL)throw new Error("Value Stack underflow");const r=P(n.stack);return n.stack=E(n.stack),r}function X(n,r,t){switch(t.tag){case c.ATOM:{const e=O(r,t);switch(e.tag){case c.CLOS:case c.PRIM:return e;default:return a(n,e)}}case c.NIL:case c.PAIR:return a(n,H(t,r.head));default:return a(n,t)}}async function U(n,r,t){const e=[[t,r]];for(;e.length;){let[i,u]=e.pop();for(;i!=n.NIL;){const m=P(i);if(i=E(i),m==n.QUOTE){if(i==n.NIL)throw new Error("Expected data following quote form");a(n,P(i)),i=E(i);continue}const g=X(n,u,m);if(g&&g.tag==c.CLOS){i!=n.NIL&&e.push([i,u]),e.push([g.clos.body,g.clos.env]);break}else g&&g.tag==c.PRIM&&await g.prim.func(n,u)}}}const z={push:(n,r)=>{a(n,O(r,o(n)))},pop:(n,r)=>{const t=o(n),e=o(n);_(r,t,e)},"eq?":(n,r)=>{a(n,q(o(n),o(n))?n.TRUE:n.NIL)},cons:(n,r)=>{const t=o(n),e=o(n);a(n,w(t,e))},car:(n,r)=>{a(n,P(o(n)))},cdr:(n,r)=>{a(n,E(o(n)))},cswap:(n,r)=>{if(o(n)!=n.NIL){const t=o(n),e=o(n);a(n,t),a(n,e)}},tag:(n,r)=>{a(n,d(o(n).tag))},read:(n,r)=>{a(n,h(n))},print:(n,r)=>{J(n,o(n))}},B={stack:(n,r)=>{a(n,n.stack)},env:(n,r)=>{a(n,r.head)},"#t":(n,r)=>{a(n,n.TRUE)},import:async(n,r)=>{const t=r.head,[e,i]=$(n,r);try{const u=await n.io.file.read(e,i);n.input=u,n.inputPos=0;const m=h(n);await U(n,r,m),a(n,r.head)}catch(u){n.io.std.printError(`Failed to import module "${e}"`),u instanceof Error&&n.io.std.printError(u.message)}finally{r.head=t}},"import*":async(n,r)=>{const t=r.head,[e,i]=$(n,r);try{const u=await n.io.file.read(e,i);n.input=u,n.inputPos=0;const m=h(n);await U(n,r,m)}catch(u){r.head=t,n.io.std.printError(`Failed to import module "${e}"`),u instanceof Error&&n.io.std.printError(u.message)}}},Y={"*":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)*f(t)))},"/":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)/f(t)))},"-":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)-f(t)))},"+":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)+f(t)))},"%":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)%f(t)))},exp:(n,r)=>{const t=o(n);a(n,d(Math.exp(f(t))))},log:(n,r)=>{const t=o(n);a(n,d(Math.log(f(t))))},cos:(n,r)=>{const t=o(n);a(n,d(Math.cos(f(t))))},nand:(n,r)=>{const t=o(n),e=o(n);a(n,d(~(f(e)&f(t))))},">>":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)>>f(t)))},"<<":(n,r)=>{const t=o(n),e=o(n);a(n,d(f(e)<<f(t)))},"gt?":(n,r)=>{const t=o(n),e=o(n);e.tag===c.STRING&&t.tag===c.STRING?a(n,e.str>t.str?n.TRUE:n.NIL):a(n,f(e)>f(t)?n.TRUE:n.NIL)},rand:(n,r)=>{a(n,d(Math.random()))},TAU:(n,r)=>{a(n,d(Math.PI*2))}};function $(n,r){const t=o(n);if(t.tag!==c.STRING)throw new Error("import expects a string operand");const e=s(n,"__script_path");let i=t.str,u="";i.endsWith(".fp")||(i=`${i}.fp`);try{u=O(r,e).atom}catch{}return _(r,e,L(i)),[i,u]}function Z(n,r){const t=K(),e={input:r,inputPos:0,readStack:[],stack:t,env:{head:t},internedAtoms:[],NIL:t,TRUE:null,QUOTE:null,PUSH:null,POP:null,io:n};e.TRUE=s(e,"#t"),e.QUOTE=s(e,"quote"),e.PUSH=s(e,"push"),e.POP=s(e,"pop");for(let[i,u]of Object.entries(z))R(e,e.env,i,u);for(let[i,u]of Object.entries(B))R(e,e.env,i,u);for(let[i,u]of Object.entries(Y))R(e,e.env,i,u);return e}async function v(n){const r=h(n);try{await U(n,n.env,r)}catch(t){t instanceof Error&&(n.io.std.printError(t.message),n.io.std.printError(t.stack??""))}}const nn="forsp-worker";let N=null,I=null;const rn={std:{readLine:function(){throw new Error("Function not implemented.")},printLine:function(n){postMessage({tag:"stdout",data:n??""})},printError:function(n){postMessage({tag:"stderr",data:n??""})}},file:{read:async function(n){return new Promise((r,t)=>{N=r,I=t,postMessage({tag:"fileRead",data:n})})}}};onmessage=function(n){switch(n.data.tag){case"program":const r=Z(rn,n.data.data);v(r).finally(()=>{postMessage({tag:"finish"})});break;case"fileReadSuccess":N==null||N(n.data.data),N=null,I=null;break;case"fileReadError":I==null||I(n.data.data),N=null,I=null;break;default:console.error(nn,"Unknown message",n.data)}}})();
